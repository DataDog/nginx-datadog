# Nginx configuration mimicking ingress-nginx controller with HTTP/2
# Based on crash logs from worker 8912

# setup custom paths that do not require root access
pid /tmp/nginx/nginx.pid;
working_directory /tmp/cores;

# Load required modules
load_module /etc/nginx/modules/ngx_http_brotli_filter_module.so;
load_module /etc/nginx/modules/ngx_http_brotli_static_module.so;

# Load Datadog module (injected)
load_module /usr/lib/nginx/modules/ngx_http_datadog_module.so;

daemon off;

worker_processes 4;
worker_rlimit_nofile 1047552;
worker_shutdown_timeout 240s;

# Thread pool for Datadog WAF
thread_pool waf_thread_pool threads=8 max_queue=1024;

error_log /dev/stderr debug;

events {
    worker_connections 16384;
    multi_accept on;
    use epoll;
}

http {
    # HTTP map directives (from ingress controller)
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    map $request_uri $proxy_upstream_name {
        ~^/json/ "backend-json";
        ~^/lua/ "backend-lua";
        ~^/get/ "backend-get";
        ~^/post/ "backend-post";
        default "backend-default";
    }

    map $request_uri $proxy_alternative_upstream_name {
        ~^/json/ "backend-json-alt";
        default "";
    }

    map $http_x_forwarded_proto $force_ssl_redirect {
        default 0;
        http 1;
    }

    map $http_x_forwarded_proto $force_no_ssl_redirect {
        default 0;
        https 1;
    }

    map $request_uri $service_name {
        ~^/json/ "json-service";
        ~^/lua/ "lua-service";
        default "default-service";
    }

    map $request_uri $service_port {
        ~^/json/ "3000";
        ~^/lua/ "3000";
        default "3000";
    }

    # Lua configuration (from ingress-nginx controller template)
    lua_package_path "/etc/nginx/lua/?.lua;;";

    # Lua shared dictionaries for ingress controller
    lua_shared_dict balancer_ewma 10M;
    lua_shared_dict balancer_ewma_last_touched_at 10M;
    lua_shared_dict balancer_ewma_locks 10M;
    lua_shared_dict certificate_data 20M;
    lua_shared_dict certificate_servers 5M;
    lua_shared_dict configuration_data 20M;
    lua_shared_dict global_throttle_cache 10M;
    lua_shared_dict ocsp_response_cache 5M;
    lua_shared_dict luaconfig 5m;

    # Initialize Lua modules (commented out - require ingress controller config)
    # init_by_lua_file /etc/nginx/lua/ngx_conf_init.lua;
    # init_worker_by_lua_file /etc/nginx/lua/ngx_conf_init_worker.lua;

    # Datadog AppSec configuration
    datadog_agent_url http://${DD_AGENT_HOST}:8126;
    datadog_appsec_enabled on;
    datadog_waf_thread_pool_name waf_thread_pool;

    # Proxy cache configuration (from http-snippet in Helm config)
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=common_proxy_cache:120m max_size=2g inactive=7d use_temp_path=off;
    proxy_cache_key "$scheme$request_method$host$request_uri";

    # Basic settings
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # AIO settings (from production coredump config)
    aio                 threads;
    aio_write           on;
    keepalive_timeout 75s;
    keepalive_requests 100;
    client_header_timeout 60s;
    client_body_timeout 60s;
    send_timeout 60s;
    types_hash_max_size 2048;

    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Logging
    log_format json_combined escape=json
        '{'
        '"host":"$host",'
        '"remote_addr":"$remote_addr",'
        '"request_id":"$request_id",'
        '"x-forward-for":"$http_x_forwarded_for",'
        '"remote_user":"$remote_user",'
        '"request":"$request",'
        '"uri":"$uri",'
        '"method":"$request_method",'
        '"status":$status,'
        '"http_referrer":"$http_referer",'
        '"http_user_agent":"$http_user_agent",'
        '"request_time":$request_time,'
        '"bytes_sent":$bytes_sent,'
        '"request_proto":"$server_protocol",'
        '"request_query":"$query_string",'
        '"request_length":$request_length,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_status":"$upstream_status"'
        '}';

    access_log /dev/stdout json_combined;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript
               application/json application/javascript application/xml+rss
               application/rss+xml font/truetype font/opentype
               application/vnd.ms-fontobject image/svg+xml;

    # Brotli compression (similar to ingress-nginx controller)
    brotli on;
    brotli_comp_level 6;
    brotli_min_length 256;
    brotli_types text/plain text/css text/xml text/javascript
                 application/json application/javascript application/xml+rss
                 application/rss+xml font/truetype font/opentype
                 application/vnd.ms-fontobject image/svg+xml;

    # Buffer sizes
    client_body_buffer_size 16k;
    client_header_buffer_size 64k;
    large_client_header_buffers 4 64k;
    client_max_body_size 50m;

    # Lingering close settings (to trigger lingering read logs)
    # Use "always" to ensure lingering close happens on all connections
    lingering_close always;
    lingering_time 10s;
    lingering_timeout 2s;

    # Proxy settings
    proxy_connect_timeout 5s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # Upstream for backend_rs
    upstream backend {
        server 0.0.0.1:1;  # Placeholder for Lua balancer
        keepalive 32;
        keepalive_requests 100;
        keepalive_timeout 60s;

        # Lua balancer
        balancer_by_lua_file /etc/nginx/lua/balancer.lua;
    }

    # HTTP/2 server with SSL (required for HTTP/2)
    server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;
        server_name _;

        # Enable HTTP/2 (new syntax for nginx 1.25.1+)
        http2 on;
        http2_max_concurrent_streams 128;

        # Self-signed certificate for testing
        ssl_certificate /etc/nginx/ssl/nginx.crt;
        ssl_certificate_key /etc/nginx/ssl/nginx.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        # SSL settings from production coredump config
        ssl_early_data on;
        ssl_session_cache shared:SSL:64m;
        ssl_session_timeout 1d;
        ssl_session_tickets off;

        # AGGRESSIVE timeouts to trigger GOAWAY
        keepalive_timeout 2s;  # Very short idle timeout
        keepalive_requests 3;  # Trigger GOAWAY after just 3 requests
        keepalive_time 3s;  # Maximum connection time before GOAWAY

        # Lua socket test endpoint
        location /lua/socket {
            content_by_lua_file /etc/nginx/lua/socket_test.lua;
        }

        # Lua threads test endpoint
        location /lua/threads {
            content_by_lua_file /etc/nginx/lua/threads_test.lua;
        }

        # Lua subrequest test endpoint
        location /lua/subrequest {
            content_by_lua_file /etc/nginx/lua/subrequest_test.lua;
        }

        # Lua timer test endpoint (creates fake requests)
        location /lua/timer {
            content_by_lua_file /etc/nginx/lua/timer_test.lua;
        }


        # JSON endpoint - disable compression for AppSec response body scanning
        location /json/ {
            # Set variables for auth
            set $auth_token $http_x_token;
            set $req_uri $request_uri;

            # HTTP script variables (from ingress controller)
            set $proxy_upstream_name $proxy_upstream_name;
            set $proxy_alternative_upstream_name $proxy_alternative_upstream_name;
            set $force_ssl_redirect $force_ssl_redirect;
            set $force_no_ssl_redirect $force_no_ssl_redirect;
            set $service_name $service_name;
            set $service_port $service_port;

            # HTTP script with literal values (triggers "http script value" logs)
            set $namespace "default";
            set $ingress_name "test-ingress";
            set $location_path "/json/";
            set $pass_access_scheme "https";
            set $pass_server_port "443";
            set $pass_port "3000";
            set $proxy_host "backend";

            # Enable Lua handlers
            access_by_lua_file /etc/nginx/lua/access.lua;
            body_filter_by_lua_file /etc/nginx/lua/body_filter.lua;
            log_by_lua_file /etc/nginx/lua/log.lua;

            # Disable compression to preserve Content-Length for AppSec
            gzip off;
            brotli off;

            # Try caching to force nginx to set content_length_n
            proxy_cache common_proxy_cache;
            proxy_cache_valid 200 1m;
            proxy_cache_key "$scheme$request_method$host$request_uri";
            proxy_ignore_headers Cache-Control Expires;

            # Proxy to backend
            proxy_pass http://backend;
            proxy_http_version 1.1;
			proxy_set_header Accept-Encoding "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            proxy_set_header Connection "";

            # Force proxy buffering for AppSec response body scanning
            proxy_buffering on;
            proxy_buffer_size 128k;
            proxy_buffers 8 256k;
            proxy_busy_buffers_size 256k;

            # Preserve Content-Length from upstream for AppSec
            proxy_pass_header Content-Length;
        }

        location / {
            # Set variables for auth
            set $auth_token $http_x_token;
            set $req_uri $request_uri;

            # HTTP script variables (from ingress controller)
            set $proxy_upstream_name $proxy_upstream_name;
            set $proxy_alternative_upstream_name $proxy_alternative_upstream_name;
            set $force_ssl_redirect $force_ssl_redirect;
            set $force_no_ssl_redirect $force_no_ssl_redirect;
            set $service_name $service_name;
            set $service_port $service_port;

            # HTTP script with literal values (triggers "http script value" logs)
            set $namespace "default";
            set $location_path "/";
            set $pass_access_scheme "https";
            set $pass_port "3000";

            # Enable Lua handlers
            access_by_lua_file /etc/nginx/lua/access.lua;
            body_filter_by_lua_file /etc/nginx/lua/body_filter.lua;
            log_by_lua_file /etc/nginx/lua/log.lua;

            # Proxy to backend
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Request-ID $request_id;
            proxy_set_header Connection "";

            # Allow client to disable buffering for specific requests only
            proxy_set_header X-accel-buffering $http_x_accel_buffering;
        }

        # API endpoints
        location /api/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
        }

        # Health check
        location /healthz {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Test endpoint for bad requests and error handling
        location /test/bad-request {
            # This will test error handling
            if ($http_x_test_error) {
                return 400 "Bad Request Test\n";
            }
            return 200 "OK\n";
        }

        # Test endpoint for discard body
        location /test/discard-body {
            # Discard request body to trigger related logs
            proxy_pass http://backend;
            proxy_request_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }

    # HTTP redirect to HTTPS
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;

        location / {
            return 301 https://$host$request_uri;
        }

        # Health check on HTTP
        location /healthz {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }

    # Additional HTTP server without redirect (for testing)
    server {
        listen 8080;
        listen [::]:8080;
        server_name _;

        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Connection "";
        }
    }
}

