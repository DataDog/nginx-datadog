#!/bin/sh

if [ -z "${ARCH}" ]; then
    export ARCH=$(arch)
fi

cd "$(dirname "$0")/../"

set -e

if [[ "${RESTY_TEST}" = "ON" ]]; then
    export BASE_IMAGE="openresty/openresty:${RESTY_VERSION}-alpine"
else
    export BASE_IMAGE="nginx:${NGINX_VERSION}-alpine"
fi


printf "      arch : %s\n" "${ARCH}"
printf "base image : %s\n" "${BASE_IMAGE}"
printf "openresty  : %s\n" "${RESTY_TEST}"
printf " test args : %s\n" "$@"

docker compose build --parallel --progress=plain
python3 -m unittest "$@"
