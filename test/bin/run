#!/bin/sh

if [ -z "${ARCH}" ]; then
    ARCH="$(arch)"
    export ARCH
fi

cd "$(dirname "$0")/../"

set -e

if [ -z "${BASE_IMAGE}" ]; then
    if [ -z "${RESTY_VERSION}" ]; then
        export BASE_IMAGE="nginx:${NGINX_VERSION}-alpine"
    else
        export BASE_IMAGE="openresty/openresty:${RESTY_VERSION}-alpine"
    fi
fi

printf "      arch : %s\n" "${ARCH}"
printf "base image : %s\n" "${BASE_IMAGE}"
printf " test args : %s\n" "$@"

docker compose build --parallel --progress=plain
python3 -m unittest "$@"
