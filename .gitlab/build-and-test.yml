format:
  stage: build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/dd-trace-cpp-ci
  tags: ["arch:amd64"]
  script:
    - pip install -r requirements.txt
    - update-alternatives --install /usr/local/bin/yapf3 yapf3 /usr/local/bin/yapf 100
    - make lint

shellcheck:
  stage: build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  tags: ["arch:amd64"]
  script:
    - find bin/ test/ example/ -type f -executable | xargs shellcheck --exclude SC1071,SC1091,SC2317

build:
  stage: build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  parallel:
    matrix:
      - arch: ["amd64", "arm64"]
        # The version used by system-tests must be one of the ones below. See https://github.com/DataDog/system-tests/pull/6113.
        NGINX_VERSION: ["1.24.0", "1.25.4", "1.28.1", "1.29.4"]
        WAF: ["ON", "OFF"]
  tags: ["arch:$arch"]
  variables:
    BUILD_TYPE: "RelWithDebInfo"
    GIT_SUBMODULE_STRATEGY: recursive
    MAKE_JOB_COUNT: "8"
    RUM: "OFF"
  before_script:
    - |
      if [ "$arch" == "amd64" ]; then
        export ARCH=x86_64
      else
        export ARCH=aarch64
      fi
  script:
    - make build-musl-aux
  artifacts:
    paths:
      - .musl-build/ngx_http_datadog_module.so
      - .musl-build/ngx_http_datadog_module.so.debug

build-openresty:
  stage: build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  parallel:
    matrix:
      - arch: ["amd64", "arm64"]
        RESTY_VERSION: ["1.27.1.2"]
        WAF: ["ON", "OFF"]
  tags: ["arch:$arch"]
  variables:
    BUILD_TYPE: "RelWithDebInfo"
    GIT_SUBMODULE_STRATEGY: recursive
    MAKE_JOB_COUNT: "8"
  before_script:
    - |
      if [ "$arch" == "amd64" ]; then
        export ARCH=x86_64
      else
        export ARCH=aarch64
      fi
  script:
    - make build-openresty
  artifacts:
    paths:
      - .openresty-build/ngx_http_datadog_module.so
      - .openresty-build/ngx_http_datadog_module.so.debug
