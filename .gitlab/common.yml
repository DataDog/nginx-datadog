.build:
  image: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  tags: ["arch:$ARCH"]
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    MAKE_JOB_COUNT: "8"

.build-nginx:
  extends: .build
  variables:
    RUM: "OFF"
  script:
    - make build-musl-aux
    - mkdir -p artifacts/$ARCH/$NGINX_VERSION/$WAF
    - cp .musl-build/ngx_http_datadog_module.so* artifacts/$ARCH/$NGINX_VERSION/$WAF/
  artifacts:
    paths:
      - artifacts/$ARCH/$NGINX_VERSION/$WAF/

.build-openresty:
  extends: .build
  script:
    - make build-openresty
    - mkdir -p artifacts-openresty/$ARCH/$RESTY_VERSION/$WAF
    - cp .openresty-build/ngx_http_datadog_module.so* artifacts-openresty/$ARCH/$RESTY_VERSION/$WAF/
  artifacts:
    paths:
      - artifacts-openresty/$ARCH/$RESTY_VERSION/$WAF/

.build-ingress-nginx:
  extends: .build
  variables:
    WAF: "ON"
  script:
    - make build-ingress-nginx
    - mkdir -p artifacts-ingress/$ARCH/$INGRESS_NGINX_VERSION
    - cp .musl-build/ngx_http_datadog_module.so* artifacts-ingress/$ARCH/$INGRESS_NGINX_VERSION/
  artifacts:
    paths:
      - artifacts-ingress/$ARCH/$INGRESS_NGINX_VERSION/

.test:
  image: registry.ddbuild.io/ci/nginx-datadog/test
  tags: ["docker-in-docker:$ARCH"]

.test-nginx:
  extends: .test
  script:
    - python3 test/bin/run.py --image $BASE_IMAGE --module-path artifacts/$ARCH/$NGINX_VERSION/$WAF/ngx_http_datadog_module.so -- --verbose --failfast
  artifacts:
    paths:
      - test/logs/test.log

.test-ingress-nginx:
  extends: .test
  variables:
    NGINX_FLAVOR: ingress-nginx
  script:
    - python3 test/bin/run.py --image registry.k8s.io/ingress-nginx/controller:v$INGRESS_NGINX_VERSION --module-path artifacts-ingress/$ARCH/$INGRESS_NGINX_VERSION/ngx_http_datadog_module.so -- --verbose --failfast
  artifacts:
    paths:
      - test/logs/test.log

.test-openresty:
  extends: .test
  script:
    - python3 test/bin/run.py --image openresty/openresty:$RESTY_VERSION-alpine --module-path artifacts-openresty/$ARCH/$RESTY_VERSION/$WAF/ngx_http_datadog_module.so -- --verbose --failfast
  artifacts:
    paths:
      - test/logs/test.log
