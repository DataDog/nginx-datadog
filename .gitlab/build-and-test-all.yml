include:
  - local: ".gitlab/common.yml"

# We split build and test all in two stages because GitLab is not able to handle dependencies graph
# with more than 100 jobs!

.build-and-test-all:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+/
      when: always
    - when: never

.build-all:
  extends: .build-and-test-all
  stage: build-all

.test-all:
  extends: .build-and-test-all
  stage: test-all

build-nginx-all:
  extends:
    - .build-all
    - .build-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        NGINX_VERSION:
          - "1.24.0"
          - "1.25.0"
          - "1.25.1"
          - "1.25.2"
          - "1.25.3"
          - "1.25.4"
          - "1.25.5"
          - "1.26.0"
          - "1.26.1"
          - "1.26.2"
          - "1.26.3"
          - "1.27.0"
          - "1.27.1"
          - "1.27.2"
          - "1.27.3"
          - "1.27.4"
          - "1.27.5"
          - "1.28.0"
          - "1.28.1"
          - "1.28.2"
          - "1.29.0"
          - "1.29.1"
          - "1.29.2"
          - "1.29.3"
          - "1.29.4"
          - "1.29.5"
        WAF: ["ON", "OFF"]

build-ingress-nginx-all:
  extends:
    - .build-all
    - .build-ingress-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        INGRESS_NGINX_VERSION:
          - "1.10.0"
          - "1.10.1"
          - "1.10.2"
          - "1.10.3"
          - "1.10.4"
          - "1.10.5"
          - "1.10.6"
          - "1.11.0"
          - "1.11.1"
          - "1.11.2"
          - "1.11.3"
          - "1.11.4"
          - "1.11.5"
          - "1.11.6"
          - "1.11.7"
          - "1.11.8"
          - "1.12.0"
          - "1.12.1"
          - "1.12.2"
          - "1.12.3"
          - "1.12.4"
          - "1.12.5"
          - "1.12.6"
          - "1.12.7"
          - "1.12.8"
          - "1.13.0"
          - "1.13.1"
          - "1.13.2"
          - "1.13.3"
          - "1.13.4"
          - "1.13.5"
          - "1.13.6"
          - "1.13.7"
          - "1.14.0"
          - "1.14.1"
          - "1.14.2"
          - "1.14.3"

build-openresty-all:
  extends:
    - .build-all
    - .build-openresty
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        RESTY_VERSION:
          - "1.25.3.1"
          - "1.25.3.2"
          - "1.27.1.1"
          - "1.27.1.2"
        WAF: ["ON", "OFF"]

test-nginx-all:
  extends:
    - .test-all
    - .test-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.24.0", "nginx:1.24.0-alpine"]
        NGINX_VERSION: ["1.24.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.0", "nginx:1.25.0-alpine"]
        NGINX_VERSION: ["1.25.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.1", "nginx:1.25.1-alpine"]
        NGINX_VERSION: ["1.25.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.2", "nginx:1.25.2-alpine"]
        NGINX_VERSION: ["1.25.2"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.3", "nginx:1.25.3-alpine"]
        NGINX_VERSION: ["1.25.3"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.4", "nginx:1.25.4-alpine"]
        NGINX_VERSION: ["1.25.4"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.5", "nginx:1.25.5-alpine"]
        NGINX_VERSION: ["1.25.5"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.26.0", "nginx:1.26.0-alpine"]
        NGINX_VERSION: ["1.26.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.26.1", "nginx:1.26.1-alpine"]
        NGINX_VERSION: ["1.26.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.26.2", "nginx:1.26.2-alpine"]
        NGINX_VERSION: ["1.26.2"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.26.3", "nginx:1.26.3-alpine"]
        NGINX_VERSION: ["1.26.3"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.0", "nginx:1.27.0-alpine"]
        NGINX_VERSION: ["1.27.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.1", "nginx:1.27.1-alpine"]
        NGINX_VERSION: ["1.27.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.2", "nginx:1.27.2-alpine"]
        NGINX_VERSION: ["1.27.2"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.3", "nginx:1.27.3-alpine"]
        NGINX_VERSION: ["1.27.3"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.4", "nginx:1.27.4-alpine"]
        NGINX_VERSION: ["1.27.4"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.27.5", "nginx:1.27.5-alpine"]
        NGINX_VERSION: ["1.27.5"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.0", "nginx:1.28.0-alpine"]
        NGINX_VERSION: ["1.28.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.1", "nginx:1.28.1-alpine"]
        NGINX_VERSION: ["1.28.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.2", "nginx:1.28.2-alpine"]
        NGINX_VERSION: ["1.28.2"]
        WAF: ["ON", "OFF"]

# GitLab is not able to handle a matrix with more than 200 jobs!
test-nginx-all-bis:
  extends:
    - .test-all
    - .test-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.0", "nginx:1.29.0-alpine"]
        NGINX_VERSION: ["1.29.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.1", "nginx:1.29.1-alpine"]
        NGINX_VERSION: ["1.29.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.2", "nginx:1.29.2-alpine"]
        NGINX_VERSION: ["1.29.2"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.3", "nginx:1.29.3-alpine"]
        NGINX_VERSION: ["1.29.3"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.4", "nginx:1.29.4-alpine"]
        NGINX_VERSION: ["1.29.4"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.5", "nginx:1.29.5-alpine"]
        NGINX_VERSION: ["1.29.5"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["amazonlinux:2023.3.20240219.0"]
        NGINX_VERSION: ["1.24.0"]
        WAF: ["ON", "OFF"]

test-ingress-nginx-all:
  extends:
    - .test-all
    - .test-ingress-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        INGRESS_NGINX_VERSION:
          - "1.10.0"
          - "1.10.1"
          - "1.10.2"
          - "1.10.3"
          - "1.10.4"
          - "1.10.5"
          - "1.10.6"
          - "1.11.0"
          - "1.11.1"
          - "1.11.2"
          - "1.11.3"
          - "1.11.4"
          - "1.11.5"
          - "1.11.6"
          - "1.11.7"
          - "1.11.8"
          - "1.12.0"
          - "1.12.1"
          - "1.12.2"
          - "1.12.3"
          - "1.12.4"
          - "1.12.5"
          - "1.12.6"
          - "1.12.7"
          - "1.12.8"
          - "1.13.0"
          - "1.13.1"
          - "1.13.2"
          - "1.13.3"
          - "1.13.4"
          - "1.13.5"
          - "1.13.6"
          - "1.13.7"
          - "1.14.0"
          - "1.14.1"
          - "1.14.2"
          - "1.14.3"

test-openresty-all:
  extends:
    - .test-all
    - .test-openresty
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        RESTY_VERSION:
          - "1.25.3.1"
          - "1.25.3.2"
          - "1.27.1.1"
          - "1.27.1.2"
        WAF: ["ON", "OFF"]

build-nginx-rum-all:
  extends:
    - .build-all
    - .build-nginx-rum
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        NGINX_VERSION:
          - "1.24.0"
          - "1.26.3"
          - "1.28.2"
          - "1.29.5"
        WAF: ["ON"]

test-nginx-rum-all:
  extends:
    - .test-all
    - .test-nginx-rum
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.24.0"]
        NGINX_VERSION: ["1.24.0"]
        WAF: ["ON"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.26.3"]
        NGINX_VERSION: ["1.26.3"]
        WAF: ["ON"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.2"]
        NGINX_VERSION: ["1.28.2"]
        WAF: ["ON"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.5"]
        NGINX_VERSION: ["1.29.5"]
        WAF: ["ON"]
