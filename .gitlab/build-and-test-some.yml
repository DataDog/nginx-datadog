include:
  - local: ".gitlab/common.yml"

.build-and-test-fast:
  stage: build-and-test-fast
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

format:
  extends: .build-and-test-fast
  image: registry.ddbuild.io/ci/nginx-datadog/dd-trace-cpp-ci
  tags: ["arch:amd64"]
  script:
    - pip install -r requirements.txt
    - update-alternatives --install /usr/local/bin/yapf3 yapf3 /usr/local/bin/yapf 100
    - make lint

shellcheck:
  extends: .build-and-test-fast
  image: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  tags: ["arch:amd64"]
  script:
    - find bin/ test/ example/ -type f -executable | xargs shellcheck --exclude SC1071,SC1091,SC2317

build-nginx-fast:
  extends:
    - .build-and-test-fast
    - .build-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        # The version used by system-tests must be one of the ones below. See https://github.com/DataDog/system-tests/pull/6113.
        NGINX_VERSION:
          - "1.24.0"
          - "1.25.5"
          - "1.28.1"
          - "1.28.2"
          - "1.29.5"
        WAF: ["ON", "OFF"]

build-ingress-nginx-fast:
  extends:
    - .build-and-test-fast
    - .build-ingress-nginx
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        INGRESS_NGINX_VERSION: ["1.13.7", "1.14.3"]

build-openresty-fast:
  extends:
    - .build-and-test-fast
    - .build-openresty
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        RESTY_VERSION: ["1.27.1.2"]
        WAF: ["ON", "OFF"]

test-nginx-fast:
  extends:
    - .build-and-test-fast
    - .test-nginx
  needs: [build-nginx-fast]
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.24.0", "nginx:1.24.0-alpine"]
        NGINX_VERSION: ["1.24.0"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.25.5", "nginx:1.25.5-alpine"]
        NGINX_VERSION: ["1.25.5"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.1", "nginx:1.28.1-alpine"]
        NGINX_VERSION: ["1.28.1"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.28.2", "nginx:1.28.2-alpine"]
        NGINX_VERSION: ["1.28.2"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["nginx:1.29.5", "nginx:1.29.5-alpine"]
        NGINX_VERSION: ["1.29.5"]
        WAF: ["ON", "OFF"]
      - ARCH: ["amd64", "arm64"]
        BASE_IMAGE: ["amazonlinux:2023.3.20240219.0"]
        NGINX_VERSION: ["1.24.0"]
        WAF: ["ON", "OFF"]

test-ingress-nginx-fast:
  extends:
    - .build-and-test-fast
    - .test-ingress-nginx
  needs: [build-ingress-nginx-fast]
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        INGRESS_NGINX_VERSION: ["1.13.7", "1.14.3"]

test-openresty-fast:
  extends:
    - .build-and-test-fast
    - .test-openresty
  needs: [build-openresty-fast]
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
        RESTY_VERSION: ["1.27.1.2"]
        WAF: ["ON", "OFF"]

coverage:
  extends:
    - .build-and-test-fast
    - .build
  variables:
    ARCH: "amd64"
    BASE_IMAGE: "nginx:1.26.0"
    NGINX_VERSION: "1.26.0"
    WAF: "ON"
  tags: ["docker-in-docker:$ARCH"]
  script:
    - make coverage
