.ssi-package:
  extends: .build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/test
  variables:
    GIT_SUBMODULE_STRATEGY: none
    TOOLCHAIN_IMAGE: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  before_script:
    - apk add --no-cache git docker-cli-buildx
    - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/".insteadOf "https://github.com/DataDog/"
    - git submodule sync --recursive
    - git submodule update --init --recursive

ssi-package-create:
  extends: .ssi-package
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
  tags: ["docker-in-docker:$ARCH"]
  script:
    - VERSION="${CI_COMMIT_TAG:-0.0.1-${CI_COMMIT_SHORT_SHA}}"
    - docker buildx create --name ssi-builder --driver docker-container
        --config buildkitd.toml --use
    - SSI_PACKAGE_VERSION="$VERSION" docker buildx bake
        ssi-package-create-${ARCH}
  artifacts:
    paths:
      - artifacts/ssi-packages/*.tar

ssi-package-merge:
  extends: .ssi-package
  needs: [ssi-package-create]
  tags: ["docker-in-docker:amd64"]
  script:
    - VERSION="${CI_COMMIT_TAG:-0.0.1-${CI_COMMIT_SHORT_SHA}}"
    - docker buildx create --name merge-builder --driver docker-container --use
    - SSI_PACKAGE_VERSION="$VERSION" docker buildx bake ssi-package-merge
  artifacts:
    paths:
      - artifacts/ssi-packages/merged.tar
