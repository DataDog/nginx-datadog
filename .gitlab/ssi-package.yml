.ssi-package:
  extends: .build-and-test
  image: registry.ddbuild.io/ci/nginx-datadog/test
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    GIT_CONFIG_COUNT: "1"
    GIT_CONFIG_KEY_0: "url.https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/.insteadOf"
    GIT_CONFIG_VALUE_0: "https://github.com/DataDog/"
    TOOLCHAIN_IMAGE: registry.ddbuild.io/ci/nginx-datadog/nginx_musl_toolchain
  before_script:
    - apk add --no-cache docker-cli-buildx
    - docker run --rm -v "$PWD/datadog-packages":/src -w /src
        -e GONOSUMCHECK="github.com/DataDog/*"
        -e GONOSUMDB="github.com/DataDog/*"
        -e GOPRIVATE="github.com/DataDog/*"
        golang:1.24-alpine sh -c
        "apk add --no-cache git &&
         git config --global url.https://gitlab-ci-token:${CI_JOB_TOKEN}@gitlab.ddbuild.io/DataDog/.insteadOf https://github.com/DataDog/ &&
         go mod vendor"

ssi-package-create:
  extends: .ssi-package
  parallel:
    matrix:
      - ARCH: ["amd64", "arm64"]
  tags: ["docker-in-docker:$ARCH"]
  variables:
    KUBERNETES_CPU_REQUEST: "32"
    KUBERNETES_CPU_LIMIT: "32"
    KUBERNETES_MEMORY_REQUEST: "64Gi"
    KUBERNETES_MEMORY_LIMIT: "64Gi"
  script:
    - VERSION="${CI_COMMIT_TAG:-0.0.1-${CI_COMMIT_SHORT_SHA}}"
    - docker buildx create --name ssi-builder --driver docker-container
        --config buildkitd.toml --use
    - SSI_PACKAGE_VERSION="$VERSION" docker buildx bake
        ssi-package-create-${ARCH}
  artifacts:
    paths:
      - artifacts/ssi-packages/*.tar

ssi-package-merge:
  extends: .ssi-package
  needs: [ssi-package-create]
  tags: ["docker-in-docker:amd64"]
  variables:
    KUBERNETES_CPU_REQUEST: "8"
    KUBERNETES_CPU_LIMIT: "8"
    KUBERNETES_MEMORY_REQUEST: "16Gi"
    KUBERNETES_MEMORY_LIMIT: "16Gi"
  script:
    - VERSION="${CI_COMMIT_TAG:-0.0.1-${CI_COMMIT_SHORT_SHA}}"
    - docker buildx create --name merge-builder --driver docker-container --use
    - SSI_PACKAGE_VERSION="$VERSION" docker buildx bake ssi-package-merge
  artifacts:
    paths:
      - artifacts/ssi-packages/merged.tar
